<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas do Casal | Dashboard</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>">
    <!-- Tailwind CSS CDN (Development only - use build version for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fa;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .field-group[hidden] { display: none; }
        .field-group { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .minimalist-table tbody tr { border-bottom: 1px solid #edf2f7; }
        .minimalist-table tbody tr:last-child { border-bottom: none; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <div id="app" class="flex flex-col lg:flex-row min-h-screen">
        
        <main class="w-full lg:flex-1 p-4 sm:p-6 lg:p-8">
            <header class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-slate-900">Suas Finan√ßas</h1>
                    <p class="text-slate-500">Acompanhe suas transa√ß√µes mensais.</p>
                </div>
                <div class="relative">
                    <button id="add-transaction-btn" class="bg-slate-900 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-colors duration-300 flex items-center space-x-2">
                        <i class="fas fa-plus"></i>
                        <span>Nova Transa√ß√£o</span>
                    </button>
                    <div id="add-transaction-menu" class="absolute right-0 mt-2 w-60 bg-white rounded-lg shadow-xl border border-slate-200 hidden z-20">
                        <a href="#" data-type="expense" class="add-type-option flex items-center px-4 py-3 text-slate-700 hover:bg-slate-100 rounded-t-lg">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-rose-100 text-rose-500 mr-3"><i class="fas fa-arrow-up"></i></span>
                            <div>
                                <p class="font-medium">Despesa</p>
                                <p class="text-xs text-slate-500">Registrar um novo gasto</p>
                            </div>
                        </a>
                        <a href="#" data-type="income" class="add-type-option flex items-center px-4 py-3 text-slate-700 hover:bg-slate-100 rounded-b-lg">
                            <span class="w-8 h-8 flex items-center justify-center rounded-full bg-emerald-100 text-emerald-500 mr-3"><i class="fas fa-arrow-down"></i></span>
                            <div>
                                <p class="font-medium">Receita</p>
                                <p class="text-xs text-slate-500">Registrar um novo ganho</p>
                            </div>
                        </a>
                    </div>
                </div>
            </header>

            <!-- Month Navigator & Filters -->
            <div class="mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center bg-white p-1 rounded-lg border border-slate-200">
                    <button id="prev-month-btn" class="p-2 rounded-md hover:bg-slate-100"><i class="fas fa-chevron-left text-slate-600"></i></button>
                    <h2 id="current-month-display" class="text-base font-bold text-slate-700 mx-4 w-32 text-center">Outubro 2025</h2>
                    <button id="next-month-btn" class="p-2 rounded-md hover:bg-slate-100"><i class="fas fa-chevron-right text-slate-600"></i></button>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <button id="filter-dropdown-btn" class="flex items-center justify-between w-48 bg-white p-2 rounded-lg border border-slate-200 shadow-sm">
                            <div class="flex items-center">
                                <span id="filter-color-indicator" class="w-3 h-3 rounded-full bg-slate-500 mr-2"></span>
                                <span id="filter-text" class="font-medium text-slate-700">Todas</span>
                            </div>
                            <i class="fas fa-chevron-down text-slate-500"></i>
                        </button>
                        <div id="filter-dropdown-menu" class="absolute mt-2 w-48 bg-white rounded-lg shadow-xl border border-slate-200 hidden z-10">
                            <a href="#" data-filter="all" class="filter-option flex items-center px-4 py-2 text-slate-700 hover:bg-slate-100">
                                <span class="w-3 h-3 rounded-full bg-slate-500 mr-2"></span>Todas
                                <i class="fas fa-check ml-auto text-slate-400 hidden check-icon"></i>
                            </a>
                            <a href="#" data-filter="expense" class="filter-option flex items-center px-4 py-2 text-slate-700 hover:bg-slate-100">
                                <span class="w-3 h-3 rounded-full bg-rose-500 mr-2"></span>Despesas
                                <i class="fas fa-check ml-auto text-slate-400 hidden check-icon"></i>
                            </a>
                            <a href="#" data-filter="income" class="filter-option flex items-center px-4 py-2 text-slate-700 hover:bg-slate-100">
                                <span class="w-3 h-3 rounded-full bg-emerald-500 mr-2"></span>Receitas
                                <i class="fas fa-check ml-auto text-slate-400 hidden check-icon"></i>
                            </a>
                        </div>
                    </div>
                     <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="search-input" placeholder="Pesquisar..." class="w-full md:w-56 pl-10 pr-4 py-2 border border-slate-200 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent sm:text-sm">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm text-left text-slate-600 minimalist-table">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-50">
                        <tr>
                            <th scope="col" class="px-6 py-4 font-medium">Situa√ß√£o</th>
                            <th scope="col" class="px-6 py-4 font-medium">Data</th>
                            <th scope="col" class="px-6 py-4 font-medium">Descri√ß√£o</th>
                            <th scope="col" class="px-6 py-4 font-medium">Categoria</th>
                            <th scope="col" class="px-6 py-4 font-medium text-right">Valor</th>
                            <th scope="col" class="px-6 py-4 font-medium text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        <!-- Table rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </main>

        <aside class="w-full lg:w-96 bg-white p-8 border-l border-slate-200">
            <div id="couple-id-container" class="mb-8 p-4 bg-slate-100 rounded-lg text-center hidden">
                <p class="text-sm text-slate-600 mb-2">Compartilhe este c√≥digo com seu par:</p>
                <div class="flex items-center justify-center bg-white p-2 rounded-md">
                    <strong id="couple-id-display" class="text-lg text-slate-800 mr-3"></strong>
                    <button id="copy-couple-id" class="p-2 rounded-md hover:bg-slate-200"><i class="fas fa-copy text-slate-600"></i></button>
                </div>
            </div>
             <div id="join-couple-container" class="mb-8 hidden">
                <p class="text-sm text-slate-600 mb-2">Para sincronizar, insira o c√≥digo do seu par:</p>
                <div class="flex gap-2">
                    <input type="text" id="join-couple-id-input" placeholder="C√≥digo..." class="w-full px-3 py-2 border border-slate-300 rounded-md">
                    <button id="join-couple-btn" class="bg-slate-900 text-white font-bold py-2 px-4 rounded-lg">Unir</button>
                </div>
            </div>

            <div class="flex items-center justify-between mb-10">
                 <div class="flex items-center">
                    <i class="fas fa-heart text-2xl text-red-500 mr-3"></i>
                    <span class="font-bold text-xl text-slate-800">Painel Financeiro</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div id="connection-status" class="flex items-center space-x-1">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span class="text-xs text-slate-500">Online</span>
                    </div>
                    <button id="settings-btn" class="w-9 h-9 rounded-full hover:bg-slate-100 flex items-center justify-center" aria-label="Configura√ß√µes"><i class="fas fa-cog text-slate-500"></i></button>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <p class="text-sm text-slate-500 mb-1">Saldo Total</p>
                    <p id="kpi-total-balance" class="text-4xl font-bold text-slate-800">R$ 0,00</p>
                </div>
                <hr class="border-slate-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center"><i class="fas fa-arrow-down"></i></div>
                    <div>
                        <p class="text-sm text-slate-500">Receitas (m√™s)</p>
                        <p id="kpi-monthly-income" class="text-lg font-bold text-emerald-600">R$ 0,00</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-lg flex items-center justify-center"><i class="fas fa-arrow-up"></i></div>
                    <div>
                        <p class="text-sm text-slate-500">Despesas (m√™s)</p>
                        <p id="kpi-monthly-expense" class="text-lg font-bold text-rose-600">R$ 0,00</p>
                    </div>
                </div>
                <hr class="border-slate-200">
                <div>
                    <p class="text-sm text-slate-500 mb-1">Balan√ßo do M√™s</p>
                    <p id="kpi-monthly-balance" class="text-2xl font-bold text-slate-700">R$ 0,00</p>
                </div>
            </div>
        </aside>

    </div>

    <!-- Modals (Add/Edit, Confirmation) -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl transform scale-95">
            <div class="flex items-center justify-between p-5 border-b border-slate-200">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800">Adicionar Transa√ß√£o</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <form id="transaction-form" class="p-6 space-y-4">
                <input type="hidden" id="transaction-id">
                <select id="type" name="type" required class="hidden">
                    <option value="expense">Despesa</option>
                    <option value="income">Receita</option>
                </select>
                <div>
                    <label for="description" class="block text-sm font-medium text-slate-700">Descri√ß√£o</label>
                    <input type="text" id="description" name="description" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500">
                </div>
                <div>
                    <label for="amount" class="block text-sm font-medium text-slate-700">Valor (R$)</label>
                    <input type="number" id="amount" name="amount" step="0.01" required placeholder="Ex: 50.75" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">Data</label>
                    <div class="mt-1 grid grid-cols-3 gap-2">
                        <div>
                            <label for="date-day" class="text-xs text-slate-500">Dia</label>
                            <select id="date-day" name="date-day" required class="mt-1 block w-full pl-3 pr-8 py-2 border-slate-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 rounded-md"></select>
                        </div>
                        <div>
                            <label for="date-month" class="text-xs text-slate-500">M√™s</label>
                            <select id="date-month" name="date-month" required class="mt-1 block w-full pl-3 pr-8 py-2 border-slate-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 rounded-md"></select>
                        </div>
                        <div>
                            <label for="date-year" class="text-xs text-slate-500">Ano</label>
                            <select id="date-year" name="date-year" required class="mt-1 block w-full pl-3 pr-8 py-2 border-slate-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 rounded-md"></select>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-slate-700">Categoria</label>
                    <select id="category" name="category" required class="mt-1 block w-full pl-3 pr-10 py-2 border-slate-300 focus:outline-none focus:ring-slate-500 focus:border-slate-500 rounded-md"></select>
                </div>
                <div id="payment-options-group">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Frequ√™ncia</label>
                    <div class="flex items-center space-x-4">
                        <label><input type="radio" name="paymentType" value="single" checked class="mr-1 text-slate-600 focus:ring-slate-500">√önica</label>
                        <label><input type="radio" name="paymentType" value="recurring" class="mr-1 text-slate-600 focus:ring-slate-500">Recorrente</label>
                        <label><input type="radio" name="paymentType" value="installment" class="mr-1 text-slate-600 focus:ring-slate-500">Parcelada</label>
                    </div>
                </div>
                <div id="installments-fields" class="field-group" hidden>
                    <label for="installments" class="block text-sm font-medium text-slate-700">N√∫mero de Parcelas</label>
                    <input type="number" id="installments" name="installments" min="2" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500">
                </div>
                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" id="cancel-btn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300">Cancelar</button>
                    <button type="submit" id="submit-btn" class="bg-slate-900 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                        <span class="submit-text">Salvar</span>
                        <span class="submit-loading hidden ml-2">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 opacity-0">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl transform scale-95 p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Confirmar Exclus√£o</h3>
            <p class="text-slate-600 mb-6">Tem certeza que deseja excluir esta transa√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-6 rounded-lg transition-colors duration-300">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-6 rounded-lg transition-colors duration-300">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            // ============================
            // FIREBASE CONFIGURATION
            // ============================
            const firebaseConfig = {
                apiKey: "AIzaSyCVrSaWM7MH2ObkezY9ZAoL0cvu6H2hQBw",
                authDomain: "roo-code-471523.firebaseapp.com",
                projectId: "roo-code-471523",
                storageBucket: "roo-code-471523.firebasestorage.app",
                messagingSenderId: "616125709991",
                appId: "1:616125709991:web:a42cf60470f6a1e4c8e582"
            };

            // Log Firebase configuration (without sensitive data)
            console.log('üîß Configura√ß√£o Firebase carregada:', {
                projectId: firebaseConfig.projectId,
                authDomain: firebaseConfig.authDomain
            });

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            // ============================
            //  STATE & DATA
            // ============================
            let transactions = [];
            let displayedDate = new Date();
            let transactionToDeleteId = null;
            let currentFilter = 'all';
            let coupleId = localStorage.getItem('coupleId');
            let transactionsUnsubscribe = null; 

            const categories = { 
                expense: ['Moradia', 'Alimenta√ß√£o', 'Transporte', 'Contas', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Vestu√°rio', 'Outros'], 
                income: ['Sal√°rio', 'Freelance', 'Investimentos', 'Presente', 'Outros'] 
            };
            const categoryVisuals = { 'Moradia': { icon: 'fa-home', color: 'bg-blue-500' }, 'Alimenta√ß√£o': { icon: 'fa-utensils', color: 'bg-orange-500' }, 'Transporte': { icon: 'fa-car', color: 'bg-yellow-500' }, 'Contas': { icon: 'fa-file-invoice-dollar', color: 'bg-red-500' }, 'Lazer': { icon: 'fa-film', color: 'bg-pink-500' }, 'Sa√∫de': { icon: 'fa-heartbeat', color: 'bg-rose-500' }, 'Educa√ß√£o': { icon: 'fa-graduation-cap', color: 'bg-purple-500' }, 'Vestu√°rio': { icon: 'fa-tshirt', color: 'bg-teal-500' }, 'Sal√°rio': { icon: 'fa-dollar-sign', color: 'bg-green-500' }, 'Freelance': { icon: 'fa-briefcase', color: 'bg-emerald-500' }, 'Investimentos': { icon: 'fa-chart-line', color: 'bg-lime-500' }, 'Presente': { icon: 'fa-gift', color: 'bg-cyan-500' }, 'Outros': { icon: 'fa-question-circle', color: 'bg-slate-500' } };
            const filterVisuals = { 'all': { text: 'Todas', color: 'bg-slate-500' }, 'expense': { text: 'Despesas', color: 'bg-rose-500' }, 'income': { text: 'Receitas', color: 'bg-emerald-500' } };

            // Selectors
            const transactionModal = document.getElementById('transaction-modal');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalTitle = document.getElementById('modal-title');
            const transactionForm = document.getElementById('transaction-form');
            const typeSelect = document.getElementById('type');
            const categorySelect = document.getElementById('category');
            const transactionIdInput = document.getElementById('transaction-id');
            const transactionsTableBody = document.getElementById('transactions-table-body');
            const currentMonthDisplay = document.getElementById('current-month-display');
            const installmentsFields = document.getElementById('installments-fields');
            const paymentOptionsGroup = document.getElementById('payment-options-group');
            const filterDropdownBtn = document.getElementById('filter-dropdown-btn');
            const filterDropdownMenu = document.getElementById('filter-dropdown-menu');
            const addTransactionBtn = document.getElementById('add-transaction-btn');
            const addTransactionMenu = document.getElementById('add-transaction-menu');
            const dateDaySelect = document.getElementById('date-day');
            const dateMonthSelect = document.getElementById('date-month');
            const dateYearSelect = document.getElementById('date-year');
            const coupleIdContainer = document.getElementById('couple-id-container');
            const joinCoupleContainer = document.getElementById('join-couple-container');
            const coupleIdDisplay = document.getElementById('couple-id-display');
            const paymentTypeRadios = document.querySelectorAll('input[name="paymentType"]');
            const filterOptions = document.querySelectorAll('.filter-option');
            const submitBtn = document.getElementById('submit-btn');
            const submitText = submitBtn.querySelector('.submit-text');
            const submitLoading = submitBtn.querySelector('.submit-loading');

            // Helper functions
            const formatCurrency = value => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDate = dateString => new Date(dateString + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const getMonthYearString = date => date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());

            // Firebase connection check and auto-reconnection
            const checkFirebaseConnection = async () => {
                try {
                    console.log('üîç Verificando conex√£o com Firebase...');
                    // Try to access Firestore with a simple operation
                    const testRef = collection(db, "test");
                    await getDoc(doc(testRef, "connection-test"));
                    console.log('‚úÖ Conex√£o com Firebase OK');
                    return true;
                } catch (error) {
                    console.error('‚ùå Problema de conex√£o com Firebase:', error);
                    return false;
                }
            };

            // Auto-reconnection function
            const attemptReconnection = async (maxAttempts = 3) => {
                for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                    console.log(`üîÑ Tentativa de reconex√£o ${attempt}/${maxAttempts}`);
                    if (await checkFirebaseConnection()) {
                        console.log('‚úÖ Reconex√£o bem-sucedida!');
                        updateConnectionStatus(true);
                        return true;
                    }
                    if (attempt < maxAttempts) {
                        console.log(`‚è≥ Aguardando 2 segundos antes da pr√≥xima tentativa...`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                console.error('‚ùå Falha ao reconectar ap√≥s todas as tentativas');
                updateConnectionStatus(false);
                return false;
            };

            // Update connection status indicator
            const updateConnectionStatus = (isOnline) => {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    const indicator = statusElement.querySelector('div');
                    const text = statusElement.querySelector('span');

                    if (isOnline) {
                        indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                        text.textContent = 'Online';
                        statusElement.className = 'flex items-center space-x-1';
                    } else {
                        indicator.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                        text.textContent = 'Offline';
                        statusElement.className = 'flex items-center space-x-1';
                    }
                }
            };

            // Loading state management
            const setSubmitButtonLoading = (loading) => {
                if (loading) {
                    submitText.classList.add('hidden');
                    submitLoading.classList.remove('hidden');
                    submitBtn.disabled = true;
                } else {
                    submitText.classList.remove('hidden');
                    submitLoading.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            };
            
            // UI Update functions
            const updateUI = () => { renderKPIs(); renderTransactionsTable(); };
            const renderKPIs = () => {
                const currentMonth = displayedDate.getMonth();
                const currentYear = displayedDate.getFullYear();
                const paidTransactionsForKPIs = transactions.filter(t => t.status === 'paid');
                const totalBalance = paidTransactionsForKPIs.reduce((acc, t) => t.type === 'income' ? acc + t.amount : acc - t.amount, 0);
                const monthlyPaidTransactions = paidTransactionsForKPIs.filter(t => { const tDate = new Date(t.date + 'T00:00:00'); return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear; });
                const monthlyIncome = monthlyPaidTransactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
                const monthlyExpense = monthlyPaidTransactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
                const monthlyBalance = monthlyIncome - monthlyExpense;
                document.getElementById('kpi-total-balance').textContent = formatCurrency(totalBalance);
                document.getElementById('kpi-monthly-income').textContent = formatCurrency(monthlyIncome);
                document.getElementById('kpi-monthly-expense').textContent = formatCurrency(monthlyExpense);
                document.getElementById('kpi-monthly-balance').textContent = formatCurrency(monthlyBalance);
            };
            const renderTransactionsTable = () => {
                transactionsTableBody.innerHTML = '';
                currentMonthDisplay.textContent = getMonthYearString(displayedDate);
                const currentMonth = displayedDate.getMonth();
                const currentYear = displayedDate.getFullYear();
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const filteredTransactions = transactions.filter(t => { const tDate = new Date(t.date + 'T00:00:00'); return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear; }).filter(t => currentFilter === 'all' || t.type === currentFilter).filter(t => t.description.toLowerCase().includes(searchTerm)).sort((a, b) => new Date(b.date) - new Date(a.date));
                if (filteredTransactions.length === 0) { transactionsTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-slate-500 py-12">Nenhuma transa√ß√£o encontrada.</td></tr>`; return; }
                filteredTransactions.forEach(t => {
                    const visual = categoryVisuals[t.category] || categoryVisuals['Outros'];
                    const isRecurringIcon = t.paymentType === 'recurring' ? `<i class="fas fa-sync-alt text-blue-500 ml-2 text-xs" title="Recorrente"></i>` : '';
                    let borderColorClass = 'border-slate-500'; if (t.type === 'income') borderColorClass = 'border-emerald-500'; if (t.type === 'expense') borderColorClass = 'border-rose-500';
                    let valueColorClass = 'text-slate-800', valuePrefix = ''; if (t.type === 'income') { valueColorClass = 'text-emerald-600'; valuePrefix = '+'; } if (t.type === 'expense') { valueColorClass = 'text-rose-600'; valuePrefix = '-'; }
                    const statusLabel = t.status === 'paid' ? 'Marcar como pendente' : 'Marcar como paga';
                    const row = `<tr class="hover:bg-slate-50 border-l-2 ${borderColorClass}"><td class="px-6 py-4"><button data-id="${t.id}" class="status-btn w-6 h-6 rounded-full flex items-center justify-center transition-transform transform hover:scale-110 ${t.status === 'paid' ? 'bg-emerald-100' : 'bg-yellow-100'}" aria-label="${statusLabel}" title="${statusLabel}"><i class="fas ${t.status === 'paid' ? 'fa-check text-emerald-600' : 'fa-clock text-yellow-600'} text-xs"></i></button></td><td class="px-6 py-4">${formatDate(t.date)}</td><td class="px-6 py-4 font-medium text-slate-800 flex items-center">${t.description} ${isRecurringIcon}</td><td class="px-6 py-4"><div class="flex items-center"><div class="w-6 h-6 rounded-full ${visual.color} text-white flex items-center justify-center text-xs mr-2" aria-hidden="true"><i class="fas ${visual.icon}"></i></div>${t.category}</div></td><td class="px-6 py-4 font-semibold text-right ${valueColorClass}">${valuePrefix} ${formatCurrency(t.amount)}</td><td class="px-6 py-4 text-center"><button data-id="${t.id}" class="edit-btn text-slate-400 hover:text-slate-600 p-1" aria-label="Editar transa√ß√£o" title="Editar"><i class="fas fa-pencil-alt" aria-hidden="true"></i></button><button data-id="${t.id}" class="delete-btn text-slate-400 hover:text-rose-600 p-1" aria-label="Excluir transa√ß√£o" title="Excluir"><i class="fas fa-trash-alt" aria-hidden="true"></i></button></td></tr>`;
                    transactionsTableBody.innerHTML += row;
                });
            };

            // Date selector functions
            const populateDays = () => {
                const selectedMonth = parseInt(dateMonthSelect.value);
                const selectedYear = parseInt(dateYearSelect.value);
                const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
                const currentDay = dateDaySelect.value;
                dateDaySelect.innerHTML = '';
                for (let i = 1; i <= daysInMonth; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; dateDaySelect.appendChild(option); }
                if (currentDay <= daysInMonth) { dateDaySelect.value = currentDay; }
            };
            const populateDateSelectors = () => {
                const currentYear = new Date().getFullYear();
                dateYearSelect.innerHTML = '';
                for (let i = currentYear + 1; i >= currentYear - 5; i--) { const option = document.createElement('option'); option.value = i; option.textContent = i; dateYearSelect.appendChild(option); }
                const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                dateMonthSelect.innerHTML = '';
                months.forEach((month, index) => { const option = document.createElement('option'); option.value = index; option.textContent = month; dateMonthSelect.appendChild(option); });
                dateMonthSelect.addEventListener('change', populateDays);
                dateYearSelect.addEventListener('change', populateDays);
            };

            // Modal Logic functions
            const openTransactionModal = (type, transaction) => {
                transactionForm.reset();
                document.querySelector('input[name="paymentType"][value="single"]').checked = true;
                installmentsFields.hidden = true;

                if (transaction) {
                    modalTitle.textContent = 'Editar Transa√ß√£o';
                    transactionIdInput.value = transaction.id;
                    document.getElementById('description').value = transaction.description;
                    document.getElementById('amount').value = transaction.amount;
                    const date = new Date(transaction.date + 'T00:00:00');
                    dateYearSelect.value = date.getFullYear();
                    dateMonthSelect.value = date.getMonth();
                    populateDays();
                    dateDaySelect.value = date.getDate();
                    typeSelect.value = transaction.type;

                    // Restore payment type radio button state
                    if (transaction.paymentType) {
                        document.querySelector(`input[name="paymentType"][value="${transaction.paymentType}"]`).checked = true;
                        if (transaction.paymentType === 'installment') {
                            installmentsFields.hidden = false;
                            document.getElementById('installments').value = transaction.installments || 2;
                        }
                    }

                    paymentOptionsGroup.hidden = true;
                } else {
                    modalTitle.textContent = 'Adicionar Transa√ß√£o';
                    transactionIdInput.value = '';
                    const today = new Date();
                    dateYearSelect.value = today.getFullYear();
                    dateMonthSelect.value = today.getMonth();
                    populateDays();
                    dateDaySelect.value = today.getDate();
                    if (type) { typeSelect.value = type; }
                    paymentOptionsGroup.hidden = false;
                }
                updateCategoryOptions();
                if (transaction && transaction.category) {
                    categorySelect.value = transaction.category;
                }
                transactionModal.classList.remove('hidden');
                setTimeout(() => { transactionModal.classList.remove('opacity-0'); transactionModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            };
            const closeTransactionModal = () => {
                transactionModal.classList.add('opacity-0');
                transactionModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => transactionModal.classList.add('hidden'), 300);
            };
            const openConfirmationModal = (id) => {
                transactionToDeleteId = id;
                confirmationModal.classList.remove('hidden');
                setTimeout(() => { confirmationModal.classList.remove('opacity-0'); confirmationModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
            };
            const closeConfirmationModal = () => {
                confirmationModal.classList.add('opacity-0');
                confirmationModal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => confirmationModal.classList.add('hidden'), 300);
            };
            const updateCategoryOptions = () => {
                const currentType = typeSelect.value;
                categorySelect.innerHTML = '';
                categories[currentType].forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; categorySelect.appendChild(option); });
            };

            // ============================
            //  FIREBASE LOGIC
            // ============================
            async function setupRealtimeListener(id) {
                if (transactionsUnsubscribe) { transactionsUnsubscribe(); }
                const transactionsRef = collection(db, "couples", id, "transactions");
                transactionsUnsubscribe = onSnapshot(transactionsRef, (snapshot) => {
                    transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateUI();
                });
            }

            async function startAppSession() {
                try {
                    console.log('üîÑ Iniciando sess√£o da aplica√ß√£o...');
                    console.log('üë§ coupleId atual:', coupleId);

                    // Check Firebase connection first
                    const isConnected = await checkFirebaseConnection();
                    updateConnectionStatus(isConnected);
                    if (!isConnected) {
                        throw new Error('N√£o foi poss√≠vel conectar ao Firebase');
                    }

                    await signInAnonymously(auth);
                    console.log('‚úÖ Autentica√ß√£o an√¥nima realizada com sucesso');

                    if (coupleId) {
                        console.log('üîç Verificando documento do casal:', coupleId);
                        const coupleDoc = await getDoc(doc(db, "couples", coupleId));
                        if (coupleDoc.exists()) {
                            console.log('‚úÖ Documento do casal encontrado, configurando listener');
                            await setupRealtimeListener(coupleId);
                            coupleIdDisplay.textContent = coupleId;
                            coupleIdContainer.classList.remove('hidden');
                            joinCoupleContainer.classList.add('hidden');
                            console.log('‚úÖ Aplica√ß√£o inicializada com sucesso');
                            updateConnectionStatus(true);
                        } else {
                            console.log('‚ùå Documento do casal n√£o encontrado, removendo coupleId');
                            localStorage.removeItem('coupleId');
                            coupleId = null;
                            startAppSession(); // Retry
                        }
                    } else {
                        console.log('üìù Nenhum coupleId encontrado, mostrando formul√°rio de conex√£o');
                        joinCoupleContainer.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao iniciar sess√£o:', error);
                    alert('Erro ao conectar com o servidor. Verifique sua conex√£o e tente novamente.');
                }
            }

            async function createNewCoupleSpace() {
                try {
                    console.log('üè† Criando novo espa√ßo de casal...');
                    const newCoupleRef = await addDoc(collection(db, "couples"), { createdAt: serverTimestamp() });
                    console.log('‚úÖ Novo espa√ßo criado com ID:', newCoupleRef.id);
                    setCoupleId(newCoupleRef.id);
                } catch (error) {
                    console.error('‚ùå Erro ao criar espa√ßo de casal:', error);
                    alert('Erro ao criar espa√ßo de casal. Verifique sua conex√£o e tente novamente.');
                    throw error;
                }
            }

            function setCoupleId(id) {
                localStorage.setItem('coupleId', id);
                coupleId = id;
                startAppSession();
            }
            
            // ============================
            //  EVENT LISTENERS
            // ============================
            document.getElementById('close-modal-btn').addEventListener('click', closeTransactionModal);
            document.getElementById('cancel-btn').addEventListener('click', closeTransactionModal);
            transactionModal.addEventListener('click', (e) => e.target === transactionModal && closeTransactionModal());
            typeSelect.addEventListener('change', updateCategoryOptions);
            paymentTypeRadios.forEach(radio => radio.addEventListener('change', (e) => installmentsFields.hidden = e.target.value !== 'installment'));
            addTransactionBtn.addEventListener('click', (e) => { e.stopPropagation(); addTransactionMenu.classList.toggle('hidden'); });
            addTransactionMenu.addEventListener('click', (e) => { e.preventDefault(); const target = e.target.closest('.add-type-option'); if(target) { openTransactionModal(target.dataset.type, null); addTransactionMenu.classList.add('hidden'); } });
            filterDropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); filterDropdownMenu.classList.toggle('hidden'); });
            filterOptions.forEach(option => option.addEventListener('click', (e) => {
                e.preventDefault();
                currentFilter = e.currentTarget.dataset.filter;
                const visual = filterVisuals[currentFilter];
                document.getElementById('filter-text').textContent = visual.text;
                document.getElementById('filter-color-indicator').className = `w-3 h-3 rounded-full mr-2 ${visual.color}`;
                filterDropdownMenu.classList.add('hidden');

                // Update check icons
                document.querySelectorAll('.filter-option .check-icon').forEach(icon => icon.classList.add('hidden'));
                e.currentTarget.querySelector('.check-icon').classList.remove('hidden');

                updateUI();
            }));
            document.addEventListener('click', (e) => { if (!filterDropdownBtn.contains(e.target)) filterDropdownMenu.classList.add('hidden'); if (!addTransactionBtn.contains(e.target)) addTransactionMenu.classList.add('hidden'); });
            
            // Form validation functions
            const validateForm = () => {
                const description = document.getElementById('description').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);
                const category = categorySelect.value;
                const day = dateDaySelect.value;
                const month = dateMonthSelect.value;
                const year = dateYearSelect.value;

                // Validate description
                if (!description) {
                    alert('Por favor, insira uma descri√ß√£o para a transa√ß√£o.');
                    document.getElementById('description').focus();
                    return false;
                }

                // Validate amount
                if (isNaN(amount) || amount <= 0) {
                    alert('Por favor, insira um valor v√°lido maior que zero.');
                    document.getElementById('amount').focus();
                    return false;
                }

                // Validate category
                if (!category) {
                    alert('Por favor, selecione uma categoria.');
                    categorySelect.focus();
                    return false;
                }

                // Validate date
                if (!day || !month || !year) {
                    alert('Por favor, selecione uma data v√°lida.');
                    return false;
                }

                // Validate date is not in future (optional, but good practice)
                const selectedDate = new Date(parseInt(year), parseInt(month), parseInt(day));
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (selectedDate > today) {
                    alert('A data n√£o pode ser no futuro.');
                    return false;
                }

                return true;
            };

            transactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validate form before processing
                if (!validateForm()) {
                    return;
                }

                // Validate coupleId before proceeding
                if (!coupleId) {
                    alert('Erro: Voc√™ n√£o est√° conectado a um espa√ßo de casal. Por favor, recarregue a p√°gina e tente novamente.');
                    console.error('‚ùå Tentativa de salvar transa√ß√£o sem coupleId v√°lido');
                    return;
                }

                console.log('üíæ Iniciando salvamento de transa√ß√£o...');
                console.log('üë§ coupleId:', coupleId);

                setSubmitButtonLoading(true);

                try {
                    const id = transactionIdInput.value;
                    const day = String(dateDaySelect.value).padStart(2, '0');
                    const month = String(parseInt(dateMonthSelect.value) + 1).padStart(2, '0');
                    const year = dateYearSelect.value;
                    const constructedDate = `${year}-${month}-${day}`;
                    const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
                    const baseTransactionData = {
                        description: document.getElementById('description').value.trim(),
                        amount: parseFloat(document.getElementById('amount').value),
                        date: constructedDate,
                        type: typeSelect.value,
                        category: categorySelect.value
                    };
                    if (id) {
                        const docRef = doc(db, "couples", coupleId, "transactions", id);
                        await setDoc(docRef, { ...baseTransactionData }, { merge: true });
                    } else {
                        if (paymentType === 'installment') {
                            const totalInstallments = parseInt(document.getElementById('installments').value);
                            if (!totalInstallments || totalInstallments < 2 || totalInstallments > 60) {
                                alert('N√∫mero de parcelas deve ser entre 2 e 60.');
                                document.getElementById('installments').focus();
                                return;
                            }
                            const startDate = new Date(constructedDate + 'T00:00:00');
                            for (let i = 1; i <= totalInstallments; i++) {
                                const installmentDate = new Date(startDate);
                                installmentDate.setMonth(startDate.getMonth() + (i - 1));
                                const installmentData = { ...baseTransactionData, description: `${baseTransactionData.description} (${i}/${totalInstallments})`, date: installmentDate.toISOString().split('T')[0], status: 'pending', paymentType: 'installment' };
                                await addDoc(collection(db, "couples", coupleId, "transactions"), installmentData);
                            }
                        } else {
                            const status = paymentType === 'single' ? 'paid' : 'pending';
                            await addDoc(collection(db, "couples", coupleId, "transactions"), { ...baseTransactionData, status, paymentType });
                        }
                    }
                    closeTransactionModal();
                } catch (error) {
                    console.error('‚ùå Erro ao salvar transa√ß√£o:', error);
                    console.error('üîç Detalhes do erro:', {
                        message: error.message,
                        code: error.code,
                        stack: error.stack,
                        coupleId: coupleId,
                        transactionData: baseTransactionData
                    });

                    // Provide more specific error messages based on error type
                    let errorMessage = 'Erro ao salvar transa√ß√£o. Tente novamente.';

                    if (error.message && error.message.includes('indexOf')) {
                        errorMessage = 'Erro de conex√£o com o banco de dados. Verifique sua conex√£o com a internet.';
                    } else if (error.code === 'permission-denied') {
                        errorMessage = 'Erro de permiss√£o. Voc√™ pode n√£o ter acesso a este espa√ßo de casal.';
                    } else if (error.code === 'not-found') {
                        errorMessage = 'Espa√ßo de casal n√£o encontrado. Tente recarregar a p√°gina.';
                    } else if (error.code === 'unavailable') {
                        errorMessage = 'Servi√ßo temporariamente indispon√≠vel. Tente novamente em alguns instantes.';
                    }

                    alert(errorMessage);
                    // Keep form data for user to retry - modal stays open
                } finally {
                    setSubmitButtonLoading(false);
                }
            });

            transactionsTableBody.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn'), deleteBtn = e.target.closest('.delete-btn'), statusBtn = e.target.closest('.status-btn');
                if (editBtn) { const transaction = transactions.find(t => t.id === editBtn.dataset.id); if (transaction) openTransactionModal(null, transaction); }
                if (deleteBtn) { openConfirmationModal(deleteBtn.dataset.id); }
                if (statusBtn) {
                    const id = statusBtn.dataset.id;
                    const transaction = transactions.find(t => t.id === id);
                    if (transaction) {
                        const newStatus = transaction.status === 'paid' ? 'pending' : 'paid';
                        const docRef = doc(db, "couples", coupleId, "transactions", id);
                        await setDoc(docRef, { status: newStatus }, { merge: true });
                    }
                }
            });
            
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmationModal);
            confirmationModal.addEventListener('click', (e) => e.target === confirmationModal && closeConfirmationModal());
            document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                if (transactionToDeleteId) {
                    await deleteDoc(doc(db, "couples", coupleId, "transactions", transactionToDeleteId));
                    closeConfirmationModal();
                    transactionToDeleteId = null;
                }
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => { displayedDate.setMonth(displayedDate.getMonth() - 1); updateUI(); });
            document.getElementById('next-month-btn').addEventListener('click', () => { displayedDate.setMonth(displayedDate.getMonth() + 1); updateUI(); });
            document.getElementById('search-input').addEventListener('input', updateUI);
            
            document.getElementById('join-couple-btn').addEventListener('click', async () => {
                const idToJoin = document.getElementById('join-couple-id-input').value.trim();

                // Validate couple ID format
                if (!idToJoin) {
                    alert('Por favor, insira o c√≥digo do casal.');
                    document.getElementById('join-couple-id-input').focus();
                    return;
                }

                if (idToJoin.length < 10) {
                    alert('C√≥digo do casal inv√°lido. Deve conter pelo menos 10 caracteres.');
                    document.getElementById('join-couple-id-input').focus();
                    return;
                }

                // Show loading state
                const joinBtn = document.getElementById('join-couple-btn');
                const originalText = joinBtn.textContent;
                joinBtn.textContent = 'Conectando...';
                joinBtn.disabled = true;

                try {
                    // First verify if the couple ID exists
                    const coupleDoc = await getDoc(doc(db, "couples", idToJoin));
                    if (coupleDoc.exists()) {
                        setCoupleId(idToJoin);
                    } else {
                        alert('C√≥digo do casal n√£o encontrado. Verifique se o c√≥digo est√° correto.');
                        document.getElementById('join-couple-id-input').focus();
                    }
                } catch (error) {
                    console.error('Erro ao conectar:', error);
                    alert('Erro ao conectar. Tente novamente.');
                } finally {
                    // Restore button state
                    joinBtn.textContent = originalText;
                    joinBtn.disabled = false;
                }
            });

            document.getElementById('copy-couple-id').addEventListener('click', () => {
                navigator.clipboard.writeText(coupleIdDisplay.textContent).then(() => alert('C√≥digo copiado!'));
            });
            
            // ============================
            //  INITIALIZATION
            // ============================
            populateDateSelectors();
            
            if(!coupleId) {
                createNewCoupleSpace();
            } else {
                startAppSession();
            }
        });
    </script>
</body>
</html>
